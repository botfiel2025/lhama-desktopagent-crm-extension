# Especifica√ß√µes T√©cnicas - Aplicativo Desktop Tkinter

## üñ•Ô∏è Vis√£o Geral do Aplicativo

O aplicativo desktop Tkinter funciona como o n√∫cleo central do sistema CRM, atuando simultaneamente como servidor HTTP, processador de dados e interface de gerenciamento local. √â respons√°vel por receber dados da extens√£o, processar com IA e fornecer insights em tempo real.

## üèóÔ∏è Arquitetura do Aplicativo

```mermaid
graph TB
    subgraph "Interface Tkinter"
        MAIN["üñºÔ∏è Janela Principal"]
        DASH["üìä Dashboard"]
        CONFIG["‚öôÔ∏è Configura√ß√µes"]
        LOGS["üìã Logs"]
        STATUS["üîó Status"]
    end
    
    subgraph "Core Services"
        HTTP["üåê HTTP Server"]
        WS["üì° WebSocket Server"]
        SCHEDULER["‚è∞ Task Scheduler"]
        QUEUE["üì¨ Message Queue"]
    end
    
    subgraph "Processing Layer"
        MSG_PROC["üí¨ Message Processor"]
        AI_ENGINE["ü§ñ AI Engine"]
        DATA_MGR["üìä Data Manager"]
        SYNC["üîÑ Sync Manager"]
    end
    
    subgraph "Storage Layer"
        SQLITE["üíæ SQLite DB"]
        CACHE["‚ö° Memory Cache"]
        FILES["üìÅ File Storage"]
        CONFIG_DB["‚öôÔ∏è Config DB"]
    end
    
    MAIN --> DASH
    MAIN --> CONFIG
    MAIN --> LOGS
    MAIN --> STATUS
    
    DASH --> HTTP
    CONFIG --> WS
    STATUS --> SCHEDULER
    LOGS --> QUEUE
    
    HTTP --> MSG_PROC
    WS --> AI_ENGINE
    SCHEDULER --> DATA_MGR
    QUEUE --> SYNC
    
    MSG_PROC --> SQLITE
    AI_ENGINE --> CACHE
    DATA_MGR --> FILES
    SYNC --> CONFIG_DB
    
    style MAIN fill:#e1f5fe
    style HTTP fill:#f3e5f5
    style AI_ENGINE fill:#e8f5e8
    style SQLITE fill:#fff3e0
```

## üéØ Funcionalidades Principais

### 1. Servidor HTTP/API

```mermaid
sequenceDiagram
    participant EXT as Extens√£o CRM
    participant HTTP as HTTP Server
    participant PROC as Message Processor
    participant AI as AI Engine
    participant DB as Database
    
    EXT->>HTTP: POST /api/messages
    HTTP->>PROC: Process message
    PROC->>AI: Analyze content
    AI->>PROC: Return insights
    PROC->>DB: Store data
    PROC->>HTTP: Response with analysis
    HTTP->>EXT: JSON response
```

**Endpoints Implementados:**
- `GET /api/health` - Status do servidor
- `POST /api/auth/login` - Autentica√ß√£o
- `POST /api/messages/capture` - Capturar mensagem
- `GET /api/messages/{id}` - Buscar mensagem
- `POST /api/analysis/generate` - Gerar an√°lise
- `GET /api/customers/{phone}` - Dados do cliente
- `GET /api/metrics/dashboard` - M√©tricas em tempo real

### 2. Interface de Gerenciamento

```mermaid
graph LR
    subgraph "Janela Principal"
        MENU["üìã Menu Principal"]
        TOOLBAR["üîß Barra Ferramentas"]
        CONTENT["üìÑ √Årea Conte√∫do"]
        STATUS_BAR["üìä Barra Status"]
    end
    
    subgraph "Abas de Conte√∫do"
        TAB1["üìà Dashboard"]
        TAB2["üí¨ Mensagens"]
        TAB3["üë• Clientes"]
        TAB4["ü§ñ IA Config"]
        TAB5["‚öôÔ∏è Sistema"]
    end
    
    CONTENT --> TAB1
    CONTENT --> TAB2
    CONTENT --> TAB3
    CONTENT --> TAB4
    CONTENT --> TAB5
```

### 3. Sistema de Monitoramento

```mermaid
flowchart TD
    MONITOR["üîç Monitor System"] --> CPU["üíª CPU Usage"]
    MONITOR --> MEM["üíæ Memory Usage"]
    MONITOR --> DISK["üíø Disk Usage"]
    MONITOR --> NET["üåê Network"]
    
    CPU --> ALERT1["‚ö†Ô∏è CPU > 80%"]
    MEM --> ALERT2["‚ö†Ô∏è RAM > 90%"]
    DISK --> ALERT3["‚ö†Ô∏è Disk > 85%"]
    NET --> ALERT4["‚ö†Ô∏è Connection Lost"]
    
    ALERT1 --> NOTIFY["üîî Notification"]
    ALERT2 --> NOTIFY
    ALERT3 --> NOTIFY
    ALERT4 --> NOTIFY
```

## üíª Especifica√ß√µes T√©cnicas

### Estrutura do Projeto

```mermaid
graph TB
    subgraph "Projeto Tkinter CRM"
        MAIN_PY["üìÑ main.py"]
        
        subgraph "Core Modules"
            SERVER["üåê server/"]
            UI["üñºÔ∏è ui/"]
            SERVICES["‚öôÔ∏è services/"]
            MODELS["üìä models/"]
        end
        
        subgraph "Server Components"
            HTTP_SRV["üì° http_server.py"]
            WS_SRV["üì° websocket_server.py"]
            API["üîå api_routes.py"]
            MIDDLEWARE["üîß middleware.py"]
        end
        
        subgraph "UI Components"
            MAIN_WIN["üñºÔ∏è main_window.py"]
            DASHBOARD["üìä dashboard.py"]
            CONFIG_UI["‚öôÔ∏è config_panel.py"]
            WIDGETS["üß© custom_widgets.py"]
        end
        
        subgraph "Services"
            AI_SVC["ü§ñ ai_service.py"]
            DB_SVC["üíæ database_service.py"]
            MSG_SVC["üí¨ message_service.py"]
            SYNC_SVC["üîÑ sync_service.py"]
        end
        
        subgraph "Configuration"
            CONFIG["‚öôÔ∏è config.py"]
            LOGGING["üìã logging_config.py"]
            CONSTANTS["üìå constants.py"]
        end
    end
```

### Depend√™ncias Python

```python
# requirements.txt
tkinter>=8.6.0          # Interface gr√°fica
fastapi>=0.104.0        # API REST
uvicorn>=0.24.0         # ASGI server
websockets>=12.0        # WebSocket support
sqlalchemy>=2.0.0       # ORM database
sqlite3                 # Database engine
requests>=2.31.0        # HTTP client
aiofiles>=23.2.0        # Async file operations
pydantic>=2.5.0         # Data validation
jsonschema>=4.20.0      # JSON validation
psutil>=5.9.0           # System monitoring
schedule>=1.2.0         # Task scheduling
watchdog>=3.0.0         # File monitoring
cryptography>=41.0.0    # Encryption
jwt>=2.8.0              # JWT tokens
redis>=5.0.0            # Cache (optional)
pillow>=10.1.0          # Image processing
matplotlib>=3.8.0       # Charts and graphs
numpy>=1.25.0           # Numerical operations
pandas>=2.1.0           # Data analysis
```

## üîß Implementa√ß√£o dos M√≥dulos

### 1. Servidor HTTP (http_server.py)

```mermaid
classDiagram
    class HTTPServer {
        +host: str
        +port: int
        +app: FastAPI
        +start_server()
        +stop_server()
        +register_routes()
        +setup_middleware()
    }
    
    class APIRoutes {
        +auth_routes()
        +message_routes()
        +customer_routes()
        +analytics_routes()
        +system_routes()
    }
    
    class Middleware {
        +cors_middleware()
        +auth_middleware()
        +logging_middleware()
        +rate_limiting()
    }
    
    HTTPServer --> APIRoutes
    HTTPServer --> Middleware
```

**Funcionalidades:**
- Servidor FastAPI ass√≠ncrono
- Autentica√ß√£o JWT
- Rate limiting
- CORS configur√°vel
- Logging de requisi√ß√µes
- Valida√ß√£o de dados com Pydantic

### 2. Interface Principal (main_window.py)

```mermaid
classDiagram
    class MainWindow {
        +root: tk.Tk
        +notebook: ttk.Notebook
        +status_bar: StatusBar
        +menu_bar: MenuBar
        +create_widgets()
        +setup_layout()
        +bind_events()
    }
    
    class Dashboard {
        +metrics_frame: tk.Frame
        +charts_frame: tk.Frame
        +update_metrics()
        +refresh_charts()
    }
    
    class ConfigPanel {
        +ai_config: AIConfigFrame
        +server_config: ServerConfigFrame
        +save_config()
        +load_config()
    }
    
    MainWindow --> Dashboard
    MainWindow --> ConfigPanel
```

**Componentes da Interface:**
- Menu principal com a√ß√µes r√°pidas
- Abas organizadas por funcionalidade
- Dashboard com m√©tricas em tempo real
- Painel de configura√ß√£o intuitivo
- Barra de status com indicadores
- Sistema de notifica√ß√µes integrado

### 3. Processador de Mensagens (message_service.py)

```mermaid
stateDiagram-v2
    [*] --> Received
    Received --> Validating : Validate data
    Validating --> Processing : Data valid
    Validating --> Error : Invalid data
    Processing --> AIAnalysis : Send to AI
    AIAnalysis --> Storing : Analysis complete
    Storing --> Notifying : Data stored
    Notifying --> Complete : Notification sent
    Complete --> [*]
    Error --> [*]
```

**Pipeline de Processamento:**
1. **Recep√ß√£o**: Captura dados da extens√£o
2. **Valida√ß√£o**: Verifica integridade dos dados
3. **Enriquecimento**: Adiciona metadados
4. **An√°lise IA**: Processa com LLaMA
5. **Armazenamento**: Salva no banco de dados
6. **Notifica√ß√£o**: Envia resultado para extens√£o

## üóÑÔ∏è Modelo de Dados

### Schema do Banco SQLite

```mermaid
erDiagram
    USERS {
        integer id PK
        text username UK
        text email UK
        text password_hash
        text role
        datetime created_at
        datetime last_login
        boolean is_active
    }
    
    CONVERSATIONS {
        integer id PK
        text whatsapp_id UK
        integer user_id FK
        text customer_name
        text customer_phone
        text status
        datetime started_at
        datetime last_message_at
        json metadata
    }
    
    MESSAGES {
        integer id PK
        integer conversation_id FK
        text content
        text message_type
        text direction
        datetime timestamp
        text media_url
        json raw_data
    }
    
    AI_ANALYSIS {
        integer id PK
        integer message_id FK
        float sentiment_score
        text intent_classification
        json suggested_responses
        text model_version
        datetime analyzed_at
        json confidence_scores
    }
    
    CUSTOMERS {
        integer id PK
        text phone UK
        text name
        text email
        json tags
        json custom_fields
        datetime first_contact
        datetime last_contact
        text status
    }
    
    SYSTEM_LOGS {
        integer id PK
        text level
        text module
        text message
        json context
        datetime timestamp
    }
    
    USERS ||--o{ CONVERSATIONS : manages
    CONVERSATIONS ||--o{ MESSAGES : contains
    MESSAGES ||--|| AI_ANALYSIS : has
    CUSTOMERS ||--o{ CONVERSATIONS : participates
```

## ‚öôÔ∏è Sistema de Configura√ß√£o

### Arquivo de Configura√ß√£o (config.json)

```json
{
  "server": {
    "host": "localhost",
    "port": 8080,
    "debug": false,
    "auto_start": true
  },
  "websocket": {
    "port": 8081,
    "max_connections": 100
  },
  "database": {
    "path": "./data/crm.db",
    "backup_interval": 3600,
    "max_backups": 10
  },
  "ai": {
    "model_path": "./models/llama",
    "max_tokens": 512,
    "temperature": 0.7,
    "use_gpu": false
  },
  "security": {
    "jwt_secret": "auto-generated",
    "token_expiry": 86400,
    "rate_limit": 100
  },
  "logging": {
    "level": "INFO",
    "file_path": "./logs/app.log",
    "max_size": "10MB",
    "backup_count": 5
  }
}
```

### Interface de Configura√ß√£o

```mermaid
graph TB
    subgraph "Painel Configura√ß√£o"
        TAB1["üåê Servidor"]
        TAB2["ü§ñ IA/LLaMA"]
        TAB3["üíæ Banco Dados"]
        TAB4["üîí Seguran√ßa"]
        TAB5["üìã Logs"]
    end
    
    subgraph "Controles Servidor"
        HOST["üè† Host/IP"]
        PORT["üîå Porta"]
        SSL["üîí SSL/TLS"]
        CORS["üåê CORS"]
    end
    
    subgraph "Controles IA"
        MODEL["üß† Modelo"]
        GPU["‚ö° GPU"]
        TEMP["üå°Ô∏è Temperature"]
        TOKENS["üìù Max Tokens"]
    end
    
    TAB1 --> HOST
    TAB1 --> PORT
    TAB1 --> SSL
    TAB1 --> CORS
    
    TAB2 --> MODEL
    TAB2 --> GPU
    TAB2 --> TEMP
    TAB2 --> TOKENS
```

## üìä Dashboard e M√©tricas

### Widgets do Dashboard

```mermaid
graph TB
    subgraph "Dashboard Principal"
        ROW1["üìä M√©tricas Hoje"]
        ROW2["üìà Gr√°ficos Tempo Real"]
        ROW3["üìã Atividade Recente"]
        ROW4["üîî Alertas Sistema"]
    end
    
    subgraph "M√©tricas Hoje"
        M1["üí¨ Mensagens"]
        M2["üë• Clientes"]
        M3["‚è±Ô∏è Tempo M√©dio"]
        M4["üéØ Taxa Convers√£o"]
    end
    
    subgraph "Gr√°ficos"
        G1["üìà Mensagens/Hora"]
        G2["üòä Sentimento"]
        G3["üè∑Ô∏è Inten√ß√µes"]
        G4["‚ö° Performance"]
    end
    
    ROW1 --> M1
    ROW1 --> M2
    ROW1 --> M3
    ROW1 --> M4
    
    ROW2 --> G1
    ROW2 --> G2
    ROW2 --> G3
    ROW2 --> G4
```

### M√©tricas em Tempo Real

```python
# Exemplo de m√©tricas coletadas
class MetricsCollector:
    def collect_realtime_metrics(self):
        return {
            "messages_today": self.count_messages_today(),
            "active_conversations": self.count_active_conversations(),
            "avg_response_time": self.calculate_avg_response_time(),
            "sentiment_distribution": self.get_sentiment_distribution(),
            "system_performance": {
                "cpu_usage": psutil.cpu_percent(),
                "memory_usage": psutil.virtual_memory().percent,
                "disk_usage": psutil.disk_usage('/').percent
            }
        }
```

## üîÑ Sistema de Sincroniza√ß√£o

### Sincroniza√ß√£o com VPS

```mermaid
sequenceDiagram
    participant LOCAL as App Local
    participant VPS as Servidor VPS
    participant BACKUP as Backup Service
    
    LOCAL->>VPS: Sync request
    VPS->>LOCAL: Last sync timestamp
    LOCAL->>LOCAL: Identify changes
    LOCAL->>VPS: Send incremental data
    VPS->>VPS: Process and store
    VPS->>BACKUP: Trigger backup
    VPS->>LOCAL: Sync confirmation
    LOCAL->>LOCAL: Update sync status
```

### Estrat√©gias de Backup

```mermaid
graph LR
    subgraph "Backup Local"
        AUTO["‚è∞ Autom√°tico"]
        MANUAL["üëÜ Manual"]
        INCREMENTAL["üìà Incremental"]
    end
    
    subgraph "Backup Remoto"
        CLOUD["‚òÅÔ∏è Cloud Storage"]
        VPS_BACKUP["üñ•Ô∏è VPS Backup"]
        ENCRYPTED["üîí Criptografado"]
    end
    
    AUTO --> CLOUD
    MANUAL --> VPS_BACKUP
    INCREMENTAL --> ENCRYPTED
```

## üöÄ Performance e Otimiza√ß√£o

### Otimiza√ß√µes Implementadas

```mermaid
graph TB
    subgraph "Otimiza√ß√µes de Performance"
        ASYNC["‚ö° Async Operations"]
        CACHE["üíæ Memory Caching"]
        POOL["üèä Connection Pooling"]
        BATCH["üì¶ Batch Processing"]
    end
    
    subgraph "Otimiza√ß√µes de UI"
        LAZY["üò¥ Lazy Loading"]
        VIRTUAL["üìú Virtual Scrolling"]
        DEBOUNCE["‚è±Ô∏è Debouncing"]
        THREAD["üßµ Background Threads"]
    end
    
    subgraph "Otimiza√ß√µes de Dados"
        INDEX["üìá Database Indexes"]
        COMPRESS["üóúÔ∏è Data Compression"]
        PAGINATE["üìÑ Pagination"]
        CLEANUP["üßπ Auto Cleanup"]
    end
```

## üîß Instala√ß√£o e Deploy

### Script de Instala√ß√£o

```bash
#!/bin/bash
# install.sh

echo "üöÄ Instalando CRM WhatsApp Desktop..."

# Verificar Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3.9+ √© necess√°rio"
    exit 1
fi

# Criar ambiente virtual
python3 -m venv venv
source venv/bin/activate

# Instalar depend√™ncias
pip install -r requirements.txt

# Criar diret√≥rios
mkdir -p data logs models backups

# Configura√ß√£o inicial
cp config.example.json config.json

# Inicializar banco
python scripts/init_database.py

echo "‚úÖ Instala√ß√£o conclu√≠da!"
echo "Execute: python main.py"
```

### Execut√°vel Standalone

```python
# build.py - Criar execut√°vel com PyInstaller
import PyInstaller.__main__

PyInstaller.__main__.run([
    'main.py',
    '--onefile',
    '--windowed',
    '--name=CRM-WhatsApp',
    '--icon=assets/icon.ico',
    '--add-data=templates;templates',
    '--add-data=static;static',
    '--hidden-import=uvicorn',
    '--hidden-import=fastapi',
])
```

## üìã Testes e Qualidade

### Estrat√©gia de Testes

```mermaid
graph TB
    subgraph "Testes Unit√°rios"
        PYTEST["üß™ PyTest"]
        MOCK["üé≠ Mocking"]
        COVERAGE["üìä Coverage"]
    end
    
    subgraph "Testes Integra√ß√£o"
        API_TEST["üîå API Tests"]
        DB_TEST["üíæ DB Tests"]
        UI_TEST["üñºÔ∏è UI Tests"]
    end
    
    subgraph "Testes Performance"
        LOAD["‚ö° Load Tests"]
        STRESS["üí™ Stress Tests"]
        MEMORY["üíæ Memory Tests"]
    end
```

---

## üìã Pr√≥ximos Passos

1. **Setup do Ambiente Python**
2. **Implementa√ß√£o do Core Tkinter**
3. **Desenvolvimento do Servidor HTTP**
4. **Integra√ß√£o com Sistema de IA**
5. **Testes de Performance**
6. **Cria√ß√£o do Execut√°vel**

---

*Especifica√ß√µes T√©cnicas - Aplicativo Tkinter*  
*Vers√£o: 1.0*  
*Data: Janeiro 2024*  
*Status: Especifica√ß√£o Completa*